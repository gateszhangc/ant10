# Binder 传播模块使用说明

## 概述
Binder是一个文件捆绑工具，可以将两个exe文件嵌入到stubloader中，创建一个单一的可执行文件。当运行捆绑后的文件时，会自动提取并执行内嵌的两个exe文件。

## 使用方法

### 基本语法
```bash
binder64.exe <stubloader64.exe> <exe1.exe> <exe2.exe> <输出文件.exe>
```

### 参数说明
- `stubloader64.exe`: 存根加载器（必须是64位）
- `exe1.exe`: 第一个要嵌入的exe文件
- `exe2.exe`: 第二个要嵌入的exe文件  
- `输出文件.exe`: 生成的捆绑文件名

### 使用示例
```bash
# 将bot.exe和c2.exe捆绑到一个文件中
./binder64.exe stubloader64.exe bot.exe c2.exe bundled_app.exe
```

## 执行机制详解

### 1. 捆绑过程（Binder工作原理）
- **PE文件解析**: 验证stubloader是否为有效的64位PE文件
- **节区创建**: 在stubloader中添加名为".bind"的新节区
- **数据嵌入**: 按以下格式存储数据：
  ```
  [MAGIC标识: 0xDEADBEEF] [exe1大小] [exe1数据] [exe2大小] [exe2数据]
  ```
- **PE头更新**: 更新节区数量、镜像大小等PE头信息
- **兼容性设置**: 设置Windows 10/11兼容性标志

### 2. 运行时执行机制（Stubloader工作原理）

#### 执行顺序：**串行执行**
```
启动捆绑文件 → 系统检查 → 提取exe1 → 执行exe1 → 提取exe2 → 执行exe2 → 退出
```

#### 详细执行流程：

1. **系统兼容性检查**
   - 检查是否为Windows 10或更高版本
   - 检查是否为64位系统
   - 如果检查失败，显示错误消息并退出

2. **查找嵌入数据**
   - 在当前进程中查找".bind"节区
   - 验证MAGIC标识(0xDEADBEEF)
   - 解析exe1和exe2的大小和数据位置

3. **串行执行程序**
   - **第一步**: 执行exe1
     - 在临时目录创建临时文件
     - 写入exe1数据到临时文件
     - 使用CreateProcess启动exe1
     - 立即关闭进程句柄（不等待完成）
     - 延迟500ms后删除临时文件
   
   - **第二步**: 执行exe2
     - 重复相同过程执行exe2

## 执行特性分析

### 执行方式：**并行执行**
虽然代码中是串行调用ExecuteProgram，但实际上是**并行执行**：
- 使用`CreateProcess`启动进程后立即调用`CloseHandle`
- **不等待**第一个程序完成就启动第二个程序
- 两个程序会同时在系统中运行

### 错误处理机制
```c
if (CreateProcessA(tempFile, NULL, NULL, NULL, FALSE, 0, NULL, NULL, &si, &pi)) {
    CloseHandle(pi.hProcess);
    CloseHandle(pi.hThread);
    // 不等待进程完成，立即继续
    Sleep(500);
    DeleteFileA(tempFile);
    return TRUE;
}
```

**错误影响分析：**
- ? **exe1失败不影响exe2**: 如果exe1启动失败，exe2仍会正常启动
- ? **exe2失败不影响exe1**: 如果exe2启动失败，exe1已经在运行
- ?? **临时文件创建失败**: 如果无法创建临时文件，该exe不会执行，但不影响另一个
- ?? **系统检查失败**: 如果系统不兼容，整个程序退出，两个exe都不会执行

### 临时文件处理
- 每个exe都会在系统临时目录创建临时文件
- 文件名格式：`exe` + 随机数字 + `.tmp`
- 启动进程后延迟500ms删除临时文件
- 如果进程启动时间超过500ms，可能会因文件被删除而失败

## 安全特性

### 系统要求
- Windows 10或更高版本
- 64位系统架构
- 足够的临时目录空间

### 反检测特性
- 使用临时文件执行，避免直接内存加载
- 快速删除临时文件
- 无持久化文件残留

## 使用建议

### 最佳实践
1. **确保兼容性**: 所有exe文件都应该是64位的
2. **测试执行顺序**: 考虑两个程序并行运行的影响
3. **处理依赖关系**: 如果程序间有依赖，考虑添加延迟机制
4. **监控资源使用**: 两个程序同时运行可能消耗更多资源

### 注意事项
- stubloader必须是64位程序
- 嵌入的exe文件大小会影响最终文件大小
- 临时文件需要足够的磁盘空间
- 某些杀毒软件可能会检测到文件捆绑行为

## 故障排除

### 常见问题
1. **"系统不兼容"错误**: 系统版本低于Windows 10
2. **"架构错误"**: 在32位系统上运行64位程序
3. **程序无响应**: 检查临时目录权限和磁盘空间
4. **exe未执行**: 检查嵌入的exe文件是否有效

### 调试建议
- 使用Process Monitor监控文件操作
- 检查Windows事件日志
- 验证嵌入文件的完整性
